<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Productos - Panel de Control</title>
  <link rel="stylesheet" href="style.css?v=4">
</head>
<body>

  <div class="app-container">
    <button class="menu-toggle" id="menu-toggle">☰</button>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <h2>Mi Tienda</h2>
      </div>
      <div class="sidebar-nav">
        <a href="/" class="active">Registro</a>
        <a href="/visualizar">Ver Productos</a>
        <a href="#" onclick="alert('Próximamente'); return false;">Configuración</a>
      </div>
      <div class="sidebar-footer">
        &copy; 2026 Mi Tienda App
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="content-wrapper">
        <div class="page-header">
          <h1>Registro de Productos</h1>
        </div>

        <div class="card">
          <form id="product-form" class="form-grid">
            <div class="form-group">
              <label for="categoria">Categoría</label>
              <input type="text" id="categoria" name="categoria" required>
            </div>
            <div class="form-group">
              <label for="precio">Precio</label>
              <input type="number" id="precio" name="precio" min="0" step="0.01" required>
            </div>
            <div class="form-group full-width">
              <label for="imagen">URL de la imagen</label>
              <input type="url" id="imagen" name="imagen" placeholder="https://ejemplo.com/imagen.jpg">
            </div>
            <div class="form-group full-width">
              <label for="descripcion">Descripción</label>
              <textarea id="descripcion" name="descripcion" required></textarea>
            </div>
            <div class="form-group full-width">
              <button type="submit" id="submit-button" class="btn btn-primary">Agregar producto</button>
            </div>
          </form>
        </div>

        <div class="card">
          <div class="form-group">
            <label for="import-file">Importar productos desde archivo (JSON)</label>
            <input type="file" id="import-file" accept="application/json">
          </div>
          
          <div class="btn-group">
            <button type="button" id="save-server-button" class="btn btn-success">Guardar en Servidor</button>
            <a href="/visualizar" class="btn btn-info">Ver Guardados</a>
          </div>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Imagen</th>
                  <th>Producto</th>
                  <th>Precio</th>
                  <th>Categoría</th>
                  <th>Subcategoría</th>
                  <th>Acción</th>
                </tr>
              </thead>
              <tbody id="products-body">
                <tr id="empty-row">
                  <td colspan="6">
                    <div class="empty-state">
                      No hay productos registrados. Usa el formulario para agregar uno o importa datos.
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <footer class="main-footer">
        <p>Panel de Administración de Productos v1.0</p>
      </footer>
    </main>
  </div>

  <script>
    var form = document.getElementById("product-form");
    var tbody = document.getElementById("products-body");
    var emptyRow = document.getElementById("empty-row");
    var submitButton = document.getElementById("submit-button");
    var importFileInput = document.getElementById("import-file");
    var saveServerButton = document.getElementById("save-server-button");

    function agregarFilaProducto(imagen, producto, precio, categoria, subcategoria, link) {
      // Verificar duplicados por nombre/producto
      var rows = tbody.querySelectorAll("tr");
      for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        if (row.id === "empty-row") continue;
        
        var cells = row.querySelectorAll("td");
        // Columna Producto es indice 1 ahora
        if (cells.length > 1 && cells[1].textContent.trim() === producto) {
          return false; // Duplicado
        }
      }

      if (emptyRow) {
        tbody.removeChild(emptyRow);
        emptyRow = null;
      }
      var row = document.createElement("tr");

      // 1. Imagen
      var imagenCell = document.createElement("td");
      imagenCell.className = "image-cell";
      if (imagen) {
        var img = document.createElement("img");
        img.src = imagen;
        img.alt = producto;
        img.style.width = "50px"; // Ajuste visual rápido
        img.style.height = "50px";
        img.style.objectFit = "contain";
        imagenCell.appendChild(img);
      }
      row.appendChild(imagenCell);

      // 2. Producto
      var productoCell = document.createElement("td");
      productoCell.textContent = producto;
      row.appendChild(productoCell);

      // 3. Precio
      var precioCell = document.createElement("td");
      precioCell.className = "price-cell";
      precioCell.textContent = typeof precio === 'number' ? precio.toFixed(2) : precio;
      row.appendChild(precioCell);

      // 4. Categoría
      var categoriaCell = document.createElement("td");
      categoriaCell.textContent = categoria;
      row.appendChild(categoriaCell);

      // 5. Subcategoría
      var subcategoriaCell = document.createElement("td");
      subcategoriaCell.textContent = subcategoria || "";
      row.appendChild(subcategoriaCell);

      // 6. Acción
      var accionCell = document.createElement("td");
      if (link) {
        var a = document.createElement("a");
        a.href = link;
        a.target = "_blank";
        a.className = "btn btn-sm btn-outline-primary";
        a.textContent = "Ver";
        accionCell.appendChild(a);
      }
      row.appendChild(accionCell);

      tbody.appendChild(row);
      return true;
    }

    form.addEventListener("submit", function (event) {
      event.preventDefault();
      submitButton.disabled = true;
      var categoria = form.categoria.value.trim();
      var precioValue = form.precio.value.trim();
      var imagen = form.imagen.value.trim();
      var descripcion = form.descripcion.value.trim(); // Usamos descripción como Producto

      if (!categoria || !precioValue || !descripcion) {
        submitButton.disabled = false;
        return;
      }

      var precio = Number(precioValue);
      if (Number.isNaN(precio) || precio < 0) {
        submitButton.disabled = false;
        return;
      }

      // Manual entry: subcategoria empty, link empty
      var agregado = agregarFilaProducto(imagen, descripcion, precio, categoria, "", "");
      
      if (!agregado) {
        alert("El producto ya existe en la lista.");
        submitButton.disabled = false;
        return;
      }

      form.reset();
      submitButton.disabled = false;
      form.categoria.focus();
    });

    if (importFileInput) {
      importFileInput.addEventListener("change", function () {
        var fileList = importFileInput.files;
        if (!fileList || !fileList[0]) {
          return;
        }
        var file = fileList[0];
        var reader = new FileReader();
        reader.onload = function () {
          var text = String(reader.result || "");
          var data;
          try {
            data = JSON.parse(text);
          } catch (error) {
            importFileInput.value = "";
            alert("Error JSON inválido");
            return;
          }
          if (!Array.isArray(data)) {
            importFileInput.value = "";
            alert("El JSON debe ser un array de productos");
            return;
          }
          var count = 0;
          data.forEach(function (item) {
            if (!item) return;

            // Soporte para formato metro_products.json y formato anterior
            var producto = item.name || item.descripcion || "";
            var precio = Number(item.price !== undefined ? item.price : item.precio);
            var categoria = item.category || item.categoria || "";
            var subcategoria = item.subcategory || item.subcategoria || "";
            var imagen = item.image || item.imagen || "";
            var link = item.link || "";

            if (!producto || Number.isNaN(precio)) {
              return;
            }
            
            if (agregarFilaProducto(imagen, producto, precio, categoria, subcategoria, link)) {
              count++;
            }
          });
          importFileInput.value = "";
          if (count > 0) {
            alert("Se importaron " + count + " productos correctamente.");
          } else {
            alert("No se importaron productos (posibles duplicados).");
          }
        };
        reader.readAsText(file);
      });
    }

    if (saveServerButton) {
      saveServerButton.addEventListener("click", function() {
        var filas = tbody.querySelectorAll("tr");
        var productos = [];
        
        filas.forEach(function(fila) {
          if (fila.id === "empty-row") return;
          
          var celdas = fila.querySelectorAll("td");
          // Indices: 0:Img, 1:Prod, 2:Precio, 3:Cat, 4:Subcat, 5:Action
          if (celdas.length < 6) return;

          var imgEl = celdas[0].querySelector("img");
          var imagen = imgEl ? imgEl.src : "";
          var productoName = celdas[1].textContent;
          var precio = parseFloat(celdas[2].textContent);
          var categoria = celdas[3].textContent;
          var subcategoria = celdas[4].textContent;
          var linkEl = celdas[5].querySelector("a");
          var link = linkEl ? linkEl.href : "";

          productos.push({
            descripcion: productoName, // Mapear a descripcion para compatibilidad backend
            name: productoName,
            precio: precio,
            price: precio,
            categoria: categoria,
            category: categoria,
            subcategoria: subcategoria,
            subcategory: subcategoria,
            imagen: imagen,
            image: imagen,
            link: link
          });
        });

        if (productos.length === 0) {
          alert("No hay productos para guardar.");
          return;
        }

        saveServerButton.disabled = true;
        saveServerButton.textContent = "Guardando...";

        fetch("/api/agregar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(productos)
        })
        .then(function(res) { 
          if (!res.ok) {
            throw new Error("Error del servidor: " + res.status); 
          }
          return res.json(); 
        })
        .then(function(data) {
          var msg = "Productos guardados correctamente.";
          if (data.agregados !== undefined) {
             msg += "\nSe agregaron " + data.agregados + " nuevos productos.";
          }
          alert(msg);
        })
        .catch(function(err) {
          console.error(err);
          alert(err.message || "Error al guardar productos.");
        })
        .finally(function() {
          saveServerButton.disabled = false;
          saveServerButton.textContent = "Guardar en Servidor";
        });
      });
    }

    // Mobile Sidebar Toggle
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.querySelector('.sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    
    function toggleSidebar() {
        sidebar.classList.toggle('active');
        sidebarOverlay.classList.toggle('active');
        menuToggle.textContent = sidebar.classList.contains('active') ? '✕' : '☰';
    }
    
    if (menuToggle) {
        menuToggle.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);
        
        // Close sidebar when clicking a link on mobile
        const sidebarLinks = sidebar.querySelectorAll('a');
        sidebarLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    toggleSidebar();
                }
            });
        });
    }
  </script>
</body>
</html>
