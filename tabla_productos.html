<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Productos Metro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }
        .price-tag {
            font-weight: bold;
            color: #d32f2f;
        }
        #loading {
            display: none;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h1 class="mb-4 text-center">Visualizador de Productos Extraídos</h1>
        
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <label for="jsonFile" class="form-label">Cargar archivo JSON (metro_products.json)</label>
                        <input class="form-control" type="file" id="jsonFile" accept=".json">
                    </div>
                    <div class="col-md-6 text-end">
                        <span id="stats" class="text-muted">Esperando archivo...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" id="searchInput" class="form-control" placeholder="Buscar producto, categoría...">
                    </div>
                    <div class="col-md-6 text-end">
                        <button id="exportBtn" class="btn btn-success btn-sm" disabled>Exportar a CSV</button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Imagen</th>
                                <th>Producto</th>
                                <th>Precio</th>
                                <th>Categoría</th>
                                <th>Subcategoría</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="productsBody">
                            <tr>
                                <td colspan="6" class="text-center py-4">Sube un archivo JSON para ver los datos</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allProducts = [];

        document.getElementById('jsonFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    allProducts = JSON.parse(content);
                    document.getElementById('stats').innerText = `Total productos: ${allProducts.length}`;
                    document.getElementById('exportBtn').disabled = false;
                    renderTable(allProducts);
                } catch (error) {
                    alert('Error al leer el archivo JSON: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        document.getElementById('searchInput').addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase();
            const filtered = allProducts.filter(p => 
                p.name.toLowerCase().includes(term) || 
                p.category.toLowerCase().includes(term) ||
                p.subcategory.toLowerCase().includes(term)
            );
            renderTable(filtered);
        });

        document.getElementById('exportBtn').addEventListener('click', function() {
            if (allProducts.length === 0) return;
            
            const headers = ['Categoria', 'Subcategoria', 'Nombre', 'Precio', 'Link'];
            const csvContent = [
                headers.join(','),
                ...allProducts.map(p => [
                    `"${p.category}"`,
                    `"${p.subcategory}"`,
                    `"${p.name.replace(/"/g, '""')}"`,
                    p.price,
                    `"${p.link}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "productos_metro.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        function renderTable(products) {
            const tbody = document.getElementById('productsBody');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">No se encontraron productos</td></tr>';
                return;
            }

            // Limit render to first 100 for performance if list is huge, or implement pagination
            // For now, let's show all or limit to 500
            const displayProducts = products.slice(0, 500);
            
            tbody.innerHTML = displayProducts.map(p => `
                <tr>
                    <td><img src="${p.image}" class="product-img" alt="img" onerror="this.src='https://placehold.co/80x80?text=No+Img'"></td>
                    <td>${p.name}</td>
                    <td class="price-tag">S/ ${p.price.toFixed(2)}</td>
                    <td><span class="badge bg-secondary">${p.category}</span></td>
                    <td><span class="badge bg-info text-dark">${p.subcategory}</span></td>
                    <td>
                        <a href="${p.link}" target="_blank" class="btn btn-sm btn-outline-primary">Ver</a>
                    </td>
                </tr>
            `).join('');

            if (products.length > 500) {
                tbody.innerHTML += `<tr><td colspan="6" class="text-center text-muted">Mostrando primeros 500 de ${products.length} resultados...</td></tr>`;
            }
        }
    </script>
</body>
</html>